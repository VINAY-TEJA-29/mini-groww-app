from flask import Flask, jsonify
from flask_cors import CORS
import yfinance as yf

app = Flask(__name__)
CORS(app)

@app.route('/stock/<symbol>')
def get_stock_data(symbol):
    try:
        stock = yf.Ticker(symbol)
        data = stock.info

        # Get historical data for the last 7 days
        hist = stock.history(period="7d")
        chart_data = []
        for date, row in hist.iterrows():
            chart_data.append({
                "date": date.strftime('%Y-%m-%d'),
                "price": round(row["Close"], 2)
            })

        result = {
            "symbol": symbol,
            "price": data.get("currentPrice"),
            "open": data.get("open"),
            "high": data.get("dayHigh"),
            "low": data.get("dayLow"),
            "volume": data.get("volume"),
            "previous_close": data.get("previousClose"),
            "change": round(data.get("currentPrice", 0) - data.get("previousClose", 0), 2),
            "change_percent": f"{round(((data.get('currentPrice', 0) - data.get('previousClose', 0)) / data.get('previousClose', 1)) * 100, 2)}%",
            "latest_trading_day": data.get("regularMarketTime"),
            "history": chart_data  # ðŸ“ˆ New field for chart
        }

        return jsonify(result)

    except Exception as e:
        return jsonify({"error": f"Failed to fetch data: {str(e)}"}), 500

if __name__ == '__main__':
    app.run(debug=True)
